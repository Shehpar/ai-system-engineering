services:
  # Our AI Anomaly Detection Application
  ai_app:
    build: 
      context: ..
      dockerfile: docker/Dockerfile
    volumes:
      - ../data:/app/data
      - ../results:/app/results
      - ../models:/app/models
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5000
    depends_on:
      - influxdb
      - mlflow
    healthcheck:
      test: ["CMD", "python", "-c", "import os,sys; sys.exit(0 if os.path.exists('/app/data/processed/system_metrics_processed.csv') else 1)"]
      interval: 30s
      timeout: 5s
      retries: 5

  # Database to store metrics for the dashboard
  influxdb:
    image: influxdb:1.8
    ports:
      - "8086:8086"
    environment:
      - INFLUXDB_DB=system_metrics
    healthcheck:
      test: ["CMD-SHELL", "influx -execute 'SHOW DATABASES' >/dev/null 2>&1"]
      interval: 30s
      timeout: 5s
      retries: 5

  # Grafana for the Visualization
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    volumes:
      - ../grafana/provisioning:/etc/grafana/provisioning
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SECURITY_ADMIN_USER=admin
    depends_on:
      - influxdb
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/api/health >/dev/null 2>&1"]
      interval: 30s
      timeout: 5s
      retries: 5

  # MLflow Tracking Server
  mlflow:
    image: python:3.11-slim
    working_dir: /mlflow
    volumes:
      - ../mlflow:/mlflow
    ports:
      - "5000:5000"
    command: >
      /bin/sh -c "pip install --no-cache-dir mlflow==2.9.2 && \
      mlflow server --host 0.0.0.0 --port 5000 \
      --backend-store-uri sqlite:///mlflow.db \
      --default-artifact-root /mlflow/artifacts"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request,sys; urllib.request.urlopen('http://localhost:5000'); sys.exit(0)"]
      interval: 30s
      timeout: 5s
      retries: 5